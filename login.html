<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Kaagaz AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root { --maroon: #800000; --beige: #F5F5DC; --saffron: #FF9933; --green: #138808; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sora', sans-serif; background: var(--beige); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; font-weight: 700; }
        .tri-color-bar { height: 6px; background: linear-gradient(90deg, var(--saffron) 0%, white 33%, var(--green) 66%, #000080 100%); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 2px solid rgba(128, 0, 0, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 24; }
        .input-field { transition: all 0.3s; }
        .input-field:focus { border-color: var(--maroon); box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--maroon) 0%, #a00000 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(128, 0, 0, 0.3); }
        .tab-active { background: var(--maroon); color: white; }
        .tab-inactive { background: white; color: var(--maroon); border: 2px solid var(--maroon); }
        @media (max-width: 640px) {
            body { padding: 0.5rem; }
            .glass { padding: 1.5rem !important; }
        }
    </style>
</head>
<body>
    <div class="tri-color-bar"></div>
    
    <div class="w-full max-w-md px-4 sm:px-6">
        <!-- Logo Section -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-maroon rounded-2xl flex items-center justify-center mx-auto mb-3 sm:mb-4 shadow-2xl">
                <span class="material-symbols-rounded text-3xl sm:text-4xl" style="color: white !important; font-variation-settings: 'FILL' 1, 'wght' 700;">folder_special</span>
            </div>
            <h1 class="text-3xl sm:text-4xl font-black text-maroon mb-2">KAAGAZ AI</h1>
            <p class="text-sm sm:text-base text-gray-600 font-bold">Intelligent Document Management System</p>
        </div>

        <!-- Auth Card -->
        <div class="glass rounded-2xl sm:rounded-3xl p-6 sm:p-8">
            <!-- Login Form -->
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Email Address</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">email</span>
                            <input type="email" id="loginEmail" required class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="admin@kaagaz.ai">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">lock</span>
                            <input type="password" id="loginPassword" required class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="w-4 h-4 rounded border-maroon text-maroon focus:ring-maroon">
                            <span class="ml-2 text-sm font-medium text-gray-600">Remember me</span>
                        </label>
                        <a href="#" class="text-sm font-bold text-maroon hover:underline">Forgot Password?</a>
                    </div>

                    <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold shadow-xl flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded" style="color: white !important; font-variation-settings: 'FILL' 1, 'wght' 700;">login</span>
                        Sign In
                    </button>

                    <!-- New User Link -->
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">
                            You are a new user? 
                            <a href="javascript:void(0)" onclick="showSignup()" class="text-maroon font-bold hover:underline">Create account</a>
                        </p>
                    </div>
                </div>
            </form>

            <!-- Sign Up Form (Hidden by default) -->
            <form id="signupForm" onsubmit="handleRegister(event)" style="display: none;">
                <div class="mb-6">
                    <button type="button" onclick="showLogin()" class="text-maroon font-bold text-sm hover:underline flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm">arrow_back</span>
                        Back to Login
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Full Name</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">person</span>
                            <input type="text" id="signupName" required class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="Enter your name">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Email Address</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">email</span>
                            <input type="email" id="signupEmail" required class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="your@email.com">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Phone Number</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">phone</span>
                            <input type="tel" id="signupPhone" class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="+91 98765 43210">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">lock</span>
                            <input type="password" id="signupPassword" required minlength="6" class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="Create strong password">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Confirm Password</label>
                        <div class="relative">
                            <span class="material-symbols-rounded absolute left-4 top-3.5 text-maroon">lock</span>
                            <input type="password" id="signupConfirmPassword" required class="input-field w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:outline-none font-medium" placeholder="Re-enter password">
                        </div>
                    </div>

                    <label class="flex items-start cursor-pointer">
                        <input type="checkbox" required class="w-4 h-4 mt-1 rounded border-maroon text-maroon focus:ring-maroon">
                        <span class="ml-2 text-sm font-medium text-gray-600">I agree to the Terms of Service and Privacy Policy</span>
                    </label>

                    <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-bold shadow-xl flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded" style="color: white !important; font-variation-settings: 'FILL' 1, 'wght' 700;">person_add</span>
                        Create Account
                    </button>
                </div>
            </form>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t-2 border-gray-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500 font-bold" style="background: rgba(255, 255, 255, 0.95) !important;">OR CONTINUE WITH</span>
                </div>
            </div>

            <!-- Social Login -->
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button onclick="handleGoogleLogin()" type="button" class="py-3 px-4 border-2 border-gray-200 rounded-xl font-bold text-gray-700 hover:border-maroon hover:bg-maroon/5 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-blue-600">mail</span>
                    Google
                </button>
                <button onclick="handlePhoneLogin()" type="button" id="phone-login-btn" class="py-3 px-4 border-2 border-gray-200 rounded-xl font-bold text-gray-700 hover:border-maroon hover:bg-maroon/5 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded">phone_android</span>
                    Phone
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6">
            <p class="text-sm text-gray-600">
                <span class="font-bold">ðŸ‡®ðŸ‡³ Made in India</span> â€¢ Secure & Private
            </p>
        </div>
    </div>

    <!-- Firebase SDK - Load First -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Custom Scripts - Load After Firebase -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Toggle between Login and Signup forms
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }
        
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }
        
        // Initialize Firebase on load
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Page loaded, initializing Firebase...');
            const firebaseReady = await initFirebase();
            
            if (!firebaseReady) {
                console.error('âŒ Firebase failed to initialize');
                alert('Authentication service unavailable. Please try again later.');
                return;
            }
            
            console.log('âœ… Firebase ready, checking for existing session...');
            
            // Handle Google redirect result FIRST
            try {
                console.log('Checking for Google redirect result...');
                const result = await handleGoogleRedirect();
                
                if (result && result.success && result.user) {
                    console.log('âœ… Google login successful:', result.user.email);
                    
                    // Store user data and redirect
                    localStorage.setItem('kaagaz_user', JSON.stringify({
                        loggedIn: true,
                        uid: result.user.uid,
                        email: result.user.email || '',
                        name: result.user.displayName || 'User',
                        photoURL: result.user.photoURL || '',
                        phone: result.user.phoneNumber || ''
                    }));
                    
                    console.log('Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                    return; // Stop execution
                } else {
                    console.log('No Google redirect result found');
                }
            } catch (error) {
                console.error('âŒ Redirect handling error:', error);
            }
            
            // Check if user is already logged in
            const user = JSON.parse(localStorage.getItem('kaagaz_user') || '{}');
            if (user && user.loggedIn && user.uid) {
                console.log('Found existing session for:', user.email || user.phone);
                
                // Verify with Firebase auth state
                auth.onAuthStateChanged((firebaseUser) => {
                    if (firebaseUser && firebaseUser.uid === user.uid) {
                        console.log('âœ… Session verified, redirecting to dashboard');
                        window.location.href = 'dashboard.html';
                    } else {
                        console.log('Session mismatch, clearing localStorage');
                        localStorage.removeItem('kaagaz_user');
                    }
                });
            } else {
                console.log('No existing session found');
            }
        });
    </script>
</body>
</html>

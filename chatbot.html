<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot | Kaagaz AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="js/session.js"></script>
    <style>
        :root { --maroon: #800000; --beige: #F5F5DC; --saffron: #FF9933; --green: #138808; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sora', sans-serif; background: var(--beige); }
        .tri-color-bar { height: 6px; background: linear-gradient(90deg, var(--saffron) 0%, white 33%, var(--green) 66%, #000080 100%); }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 2px solid rgba(128, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
        .chat-bubble { animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body>
    <div class="tri-color-bar"></div>
    
    <!-- Navigation -->
    <nav class="glass py-3 px-4 md:py-4 md:px-12 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 md:gap-4">
                <div class="w-10 h-10 md:w-12 md:h-12 bg-maroon rounded-xl flex items-center justify-center shadow-lg">
                    <span class="material-symbols-rounded text-xl md:text-2xl" style="color: white !important; font-variation-settings: 'FILL' 1, 'wght' 700;">folder_special</span>
                </div>
                <div class="hidden sm:block">
                    <div class="text-base md:text-xl font-black text-maroon">KAAGAZ AI</div>
                    <div class="text-[8px] md:text-[10px] font-bold text-gray-500 uppercase">AI Assistant</div>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-2 md:gap-3">
                <button onclick="window.location.href='dashboard.html'" class="px-3 py-2 md:px-6 md:py-3 bg-white border-2 border-maroon text-maroon rounded-lg md:rounded-xl font-bold hover:bg-maroon hover:text-white transition">
                    <span class="material-symbols-rounded text-sm align-middle">dashboard</span>
                    <span class="hidden lg:inline ml-2">Dashboard</span>
                </button>
                
                <button class="px-3 py-2 md:px-6 md:py-3 bg-maroon text-white rounded-lg md:rounded-xl font-bold transition shadow-lg">
                    <span class="material-symbols-rounded text-sm align-middle">chat</span>
                    <span class="hidden lg:inline ml-2">Chatbot</span>
                </button>
                <button onclick="window.location.href='upload.html'" class="px-3 py-2 md:px-6 md:py-3 bg-white border-2 border-maroon text-maroon rounded-lg md:rounded-xl font-bold hover:bg-maroon hover:text-white transition">
                    <span class="material-symbols-rounded text-sm align-middle">upload_file</span>
                    <span class="hidden lg:inline ml-2">Upload</span>
                </button>
                <button onclick="window.location.href='vault.html'" class="px-3 py-2 md:px-6 md:py-3 bg-white border-2 border-maroon text-maroon rounded-lg md:rounded-xl font-bold hover:bg-maroon hover:text-white transition">
                    <span class="material-symbols-rounded text-sm align-middle">folder_open</span>
                    <span class="hidden lg:inline ml-2">Documents</span>
                </button>
                <button onclick="window.location.href='profile.html'" class="hidden sm:flex px-3 py-2 md:px-6 md:py-3 bg-white border-2 border-maroon text-maroon rounded-lg md:rounded-xl font-bold hover:bg-maroon hover:text-white transition items-center">
                    <span class="material-symbols-rounded text-sm align-middle">person</span>
                    <span class="hidden lg:inline ml-2">Profile</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-6 sm:py-12">
        <div class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-black mb-3 sm:mb-4" style="color: #800000;">Ask Gemini AI</h1>
            <p class="text-sm sm:text-lg md:text-xl font-bold px-4" style="color: #2D2D2D;">Get instant answers about your documents, eligibilities, and deadlines</p>
        </div>

        <div class="glass rounded-2xl sm:rounded-3xl p-4 sm:p-8">
            <div id="chatHistory" class="bg-white/50 rounded-xl sm:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 min-h-[400px] sm:min-h-[500px] max-h-[400px] sm:max-h-[500px] overflow-y-auto space-y-4">
                <div class="chat-bubble bg-maroon/10 border-2 border-maroon/20 rounded-2xl p-6">
                    <p class="font-black text-maroon mb-2">ðŸ’¡ Try asking:</p>
                    <ul class="space-y-2 font-bold" style="color: #2D2D2D;">
                        <li>"Am I eligible for PM Scholarship?"</li>
                        <li>"When does my insurance expire?"</li>
                        <li>"What documents do I need for college admission?"</li>
                        <li>"Show me all my identity documents"</li>
                    </ul>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <input type="text" id="aiInput" placeholder="Ask about your documents..." class="flex-1 px-4 sm:px-6 py-3 sm:py-4 rounded-xl sm:rounded-2xl border-2 border-maroon/20 focus:border-maroon focus:outline-none font-bold text-base sm:text-lg text-gray-900 placeholder:text-gray-600" onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="w-full sm:w-auto px-8 sm:px-10 py-3 sm:py-4 bg-gradient-to-r from-maroon to-red-700 text-white rounded-xl sm:rounded-2xl font-bold shadow-xl hover:scale-105 transition flex items-center justify-center gap-3">
                    <span class="material-symbols-rounded text-xl sm:text-2xl" style="color: white !important; font-variation-settings: 'FILL' 1, 'wght' 700;">send</span>
                    <span style="color: white !important;">Ask</span>
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        async function sendMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message) return;

            const chat = document.getElementById('chatHistory');
            
            // User message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-bubble bg-white border-2 border-gray-200 rounded-2xl p-6 text-right ml-auto max-w-[80%]';
            userMsg.innerHTML = `<p class="font-bold text-gray-800">${message}</p>`;
            chat.appendChild(userMsg);
            
            input.value = '';
            chat.scrollTop = chat.scrollHeight;

            // Show loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-bubble bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-maroon/20 rounded-2xl p-6 max-w-[90%]';
            loadingMsg.id = 'loadingMsg';
            loadingMsg.innerHTML = `<p class="font-bold mb-2 text-maroon flex items-center gap-2"><span class="material-symbols-rounded animate-spin">refresh</span> Gemini AI:</p><p class="font-medium text-gray-800">Thinking...</p>`;
            chat.appendChild(loadingMsg);
            chat.scrollTop = chat.scrollHeight;

            try {
                // Call backend API for secure communication
                const systemPrompt = `You are Kaagaz AI, an intelligent assistant for managing Indian government documents and schemes. 

RULES:
1. Give answers in clear, numbered bullet points
2. Be concise - maximum 5-6 points per response
3. Use simple language
4. Focus on Indian documents (Aadhaar, PAN, Passport, etc.)
5. Provide actionable information
6. If asked about eligibility, list requirements as numbered points

Format your responses like this:
âœ“ Point 1
âœ“ Point 2
âœ“ Point 3

Be helpful, friendly, and precise.`;
                
                const response = await fetch('/api/chat', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        query: message,
                        systemPrompt: systemPrompt
                    })
                });

                const data = await response.json();
                
                // Remove loading message
                loadingMsg.remove();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get response');
                }

                if (data.success && data.text) {
                    const aiResponse = data.text;
                    
                    // Format response with line breaks preserved
                    const formattedResponse = aiResponse
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/âœ“/g, '<span class="text-green-600">âœ“</span>')
                        .replace(/â€¢/g, '<span class="text-maroon">â€¢</span>');
                    
                    // AI response
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'chat-bubble bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-maroon/20 rounded-2xl p-6 max-w-[90%]';
                    aiMsg.innerHTML = `
                        <p class="font-bold mb-3 text-maroon flex items-center gap-2">
                            <span class="material-symbols-rounded">smart_toy</span>
                            Gemini AI
                        </p>
                        <div class="font-medium text-gray-800 leading-relaxed">${formattedResponse}</div>
                    `;
                    chat.appendChild(aiMsg);
                } else {
                    throw new Error('No response from AI');
                }
                
            } catch (error) {
                console.error('Chat Error:', error);
                
                // Remove loading message
                document.getElementById('loadingMsg')?.remove();
                
                // Determine error message
                let errorTitle = 'Connection Error';
                let errorMessage = 'Failed to connect to AI. Please try again.';
                
                if (error.message.includes('Failed to fetch')) {
                    errorTitle = 'Network Error';
                    errorMessage = 'Cannot reach the server. Check your internet connection.';
                } else if (error.message.includes('API key not configured')) {
                    errorTitle = 'Configuration Error';
                    errorMessage = 'Gemini API key is not configured. Please contact support.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // Error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-bubble bg-red-50 border-2 border-red-300 rounded-2xl p-6 max-w-[90%]';
                errorMsg.innerHTML = `
                    <p class="font-bold mb-2 text-red-700 flex items-center gap-2">
                        <span class="material-symbols-rounded">error</span>
                        ${errorTitle}
                    </p>
                    <p class="font-medium text-red-600">${errorMessage}</p>
                `;
                chat.appendChild(errorMsg);
            }
            
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
